<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Resident Dashboard | BarangayConnect</title>
  <style>
    :root{
      --brand:#0b55b4; --brand-ink:#fff;
      --bg:#f7f9fc; --card:#ffffff; --ink:#0f172a; --muted:#64748b;
      --line:#e6ebf2; --shadow:0 8px 24px rgba(2,20,48,.08);
      --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    .navbar{height:60px;background:#0b55b4;color:#fff;display:flex;align-items:center;gap:16px;padding:0 20px}
    .navbar h1{font-size:20px;margin:0;font-weight:800}
    .navbar nav{margin-left:auto;display:flex;gap:16px;align-items:center}
    .navbar a{color:#fff;text-decoration:none;font-weight:700}
    .navbar a:hover{text-decoration:underline}
    .logout{border:0;background:transparent;color:#fff;font-weight:700;cursor:pointer}
    .shell{max-width:1200px;margin:24px auto;padding:0 16px}
    .page-title{margin:0 0 16px 0;font-size:28px;font-weight:800}
    .grid{display:grid;grid-template-columns:320px minmax(0,1fr) 360px;gap:24px;align-items:start}
    .panel{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
    .panel-header{background:var(--brand);color:var(--brand-ink);padding:12px 14px;font-weight:800;letter-spacing:.2px}
    .panel-body{padding:14px}
    .sticky{position:sticky;top:84px}
    .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:18px}
    .card{background:#eef5ff;border-radius:var(--radius);padding:24px 16px;text-align:center;color:#0b55b4;font-weight:800;box-shadow:var(--shadow)}
    .card small{display:block;margin-top:8px;color:#42536b;font-weight:600}
    .chat-top{display:flex;gap:8px;align-items:center}
    .chat-top select,.chat-input input{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;outline:none;background:#fff}
    .chat-wrap{display:flex;flex-direction:column;height:520px}
    .chat-scroll{flex:1 1 auto;overflow:auto;padding-right:4px;display:flex;flex-direction:column;gap:10px;margin-top:10px}
    .bubble{max-width:84%;padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:#f3f6fb;line-height:1.3}
    .me{align-self:flex-end;background:#eef2ff;border-color:#c7d2fe}
    .meta{font-size:.75rem;color:var(--muted);margin-top:4px}
    .chat-input{display:flex;gap:8px;align-items:center;margin-top:10px}
    .btn{background:var(--brand);color:#fff;border:none;padding:10px 14px;border-radius:10px;font-weight:800;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .ann-list{display:flex;flex-direction:column;gap:12px}
    .ann{border:1px solid var(--line);border-radius:12px;padding:12px;background:#f9fbff}
    .ann h4{margin:0 0 4px 0}
    .ann time{font-size:.8rem;color:#64748b}
    footer{margin:28px 0;text-align:center;color:#50607a}
    @media (max-width:1100px){
      .grid{grid-template-columns:1fr;gap:16px}
      .sticky{position:static;top:auto}
      .chat-wrap{height:auto;max-height:unset}
      .chat-scroll{min-height:220px;max-height:50vh}
      .chat-input{position:sticky;bottom:0;background:var(--card);z-index:1}
      .stats{grid-template-columns:1fr 1fr}
    }
    @media (max-width:600px){
      .stats{grid-template-columns:1fr}
      .page-title{font-size:22px}
      .navbar{padding:0 12px}
    }
    .disabled-link {
      opacity: 0.6;
      pointer-events: none;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <header class="navbar">
     
    <div style="display:flex;align-items:center">
      
      <h1>BarangayConnect â€” Official Dashboard</h1>
    </div>
    <nav>
      <a href="resident.html">Dashboard</a>
      <a href="report.html">Report</a>
      <button id="logoutBtn" class="logout">Logout</button>
    </nav>
  </header>

  <main class="shell">
    <h2 class="page-title" id="welcomeText">Welcome, Resident!</h2>

    <section class="grid">
      <!-- Chat Panel -->
      <aside class="panel sticky" aria-label="Direct Messages">
        <div class="panel-header">Direct Messages</div>
        <div class="panel-body">
          <div class="chat-top">
            <label for="peer" style="font-weight:700">Chat with</label>
            <select id="peer" aria-label="Select a person to chat with"></select>
          </div>
          <div class="chat-wrap">
            <div id="chatScroll" class="chat-scroll" aria-live="polite"></div>
            <form id="chatForm" class="chat-input">
              <input id="chatMsg" type="text" placeholder="Type a messageâ€¦" autocomplete="off" required/>
              <button class="btn" type="submit">Send</button>
            </form>
            <div class="meta">Private thread stored locally for now.</div>
          </div>
        </div>
      </aside>

      <!-- Stats Panel -->
      <section>
        <div class="panel">
          <div class="panel-header">Community Statistics (Santa Cruz, Makati)</div>
          <div class="panel-body">
            <div class="stats">
              <div class="card" id="wasteCard">Waste Reports: 0 <small id="wasteDate"></small></div>
              <div class="card" id="roadCard">Road Issues: 0 <small id="roadDate"></small></div>
              <div class="card" id="safetyCard">Safety Concerns: 0 <small id="safetyDate"></small></div>
              <div class="card" id="healthCard">Health Reports: 0 <small id="healthDate"></small></div>
            </div>
          </div>
        </div>
      </section>

      <!-- Announcements -->
      <aside class="panel sticky" aria-label="Announcements">
        <div class="panel-header">Announcements</div>
        <div class="panel-body">
          <div id="annList" class="ann-list"></div>
          <div class="meta" style="margin-top:8px">ðŸ”„ Refresh to see the latest updates.</div>
        </div>
      </aside>
    </section>
  </main>

  <footer>
    <small>BarangayConnect â€” Resident Dashboard (Santa Cruz, Makati)</small>
  </footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDPrpZYIJYhAmZRxW0Ph3udw-vUz6UiPNk",
      authDomain: "iss-bc.firebaseapp.com",
      projectId: "iss-bc",
      storageBucket: "iss-bc.firebasestorage.app",
      messagingSenderId: "455122393981",
      appId: "1:455122393981:web:bdf281da744767c0064a14"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const currentUser = JSON.parse(localStorage.getItem("currentUser"));
    if (!currentUser) { window.location.href="index.html"; }
    else { document.getElementById("welcomeText").textContent = `Welcome, ${currentUser.name || "Resident"}!`; }

    document.getElementById("logoutBtn").addEventListener("click", ()=>{
      localStorage.removeItem("currentUser"); window.location.href="index.html";
    });

    const AREA_KEY = "SantaCruz-Makati";
    const ANN_KEY  = `bc_ann_${AREA_KEY}`;
    const DM_KEY   = (me,peer)=> `bc_dm_${AREA_KEY}_${[me,peer].sort().join("__")}`;

    const AnnStore = {
      list(){
        const val = localStorage.getItem(ANN_KEY);
        if (val) return JSON.parse(val);
        const seed = [
          {id:crypto.randomUUID(), title:"Barangay Assembly", body:"General assembly on Nov 10, 4:00 PM at Covered Court.", ts:Date.now()-1000*60*60*24*2},
          {id:crypto.randomUUID(), title:"Waste Collection", body:"Schedule change this week: Tue & Fri, 6â€“9 AM.", ts:Date.now()-1000*60*60*6}
        ];
        localStorage.setItem(ANN_KEY, JSON.stringify(seed));
        return seed;
      }
    };

    const DMStore = {
      list(peer){ const key = DM_KEY(currentUser.name||"Resident", peer); return JSON.parse(localStorage.getItem(key) || "[]"); },
      add(peer, msg){ const key = DM_KEY(currentUser.name||"Resident", peer); const all = DMStore.list(peer); all.push(msg); localStorage.setItem(key, JSON.stringify(all)); }
    };

    const annList = document.getElementById("annList");
    function renderAnnouncements(){
      annList.innerHTML = "";
      AnnStore.list().forEach(a=>{
        const el = document.createElement("article");
        el.className = "ann";
        el.innerHTML = `<h4>${a.title}</h4><time>${new Date(a.ts).toLocaleString()}</time><p style="margin:8px 0 0">${a.body}</p>`;
        annList.appendChild(el);
      });
    }

    const knownContacts = [
      {id:"desk", name:"Barangay Help Desk"},
      {id:"captain", name:"Brgy. Captain"},
      {id:"health", name:"Official"}
    ];

    const peerSel   = document.getElementById("peer");
    const chatScroll= document.getElementById("chatScroll");
    const chatForm  = document.getElementById("chatForm");
    const chatMsg   = document.getElementById("chatMsg");

    function fillContacts(){
      peerSel.innerHTML="";
      knownContacts.forEach(p=>{
        const opt=document.createElement("option");
        opt.value=p.name; opt.textContent=p.name;
        peerSel.appendChild(opt);
      });
    }

    function renderThread(){
      chatScroll.innerHTML="";
      const me = currentUser?.name || "Resident";
      const peer = peerSel.value;
      DMStore.list(peer).slice(-250).forEach(m=>{
        const b = document.createElement("div");
        b.className = "bubble" + (m.author===me ? " me" : "");
        b.innerHTML = `<div>${m.text}</div><div class="meta">${m.author} â€¢ ${new Date(m.ts).toLocaleString()}</div>`;
        chatScroll.appendChild(b);
      });
      chatScroll.scrollTop = chatScroll.scrollHeight;
    }

    chatForm.addEventListener("submit",(e)=>{
      e.preventDefault();
      const text = chatMsg.value.trim(); if(!text) return;
      const msg = { id:crypto.randomUUID(), author: currentUser?.name || "Resident", text, ts:Date.now() };
      DMStore.add(peerSel.value, msg);
      chatMsg.value=""; renderThread();
    });
    peerSel.addEventListener("change", renderThread);

    async function loadCharts(){
      const counts = { Waste:0,Road:0,Safety:0,Health:0 };
      try{
        const snap = await getDocs(collection(db,"reports"));
        snap.forEach(doc=>{
          const r = doc.data(); if (counts[r.issueType] !== undefined) counts[r.issueType]++;
        });
      }catch(e){}
      const date = new Date().toLocaleDateString();
      document.getElementById("wasteCard").firstChild.textContent = `Waste Reports: ${counts.Waste} `;
      document.getElementById("roadCard").firstChild.textContent  = `Road Issues: ${counts.Road} `;
      document.getElementById("safetyCard").firstChild.textContent= `Safety Concerns: ${counts.Safety} `;
      document.getElementById("healthCard").firstChild.textContent= `Health Reports: ${counts.Health} `;
      document.getElementById("wasteDate").textContent  = `Updated as of ${date}`;
      document.getElementById("roadDate").textContent   = `Updated as of ${date}`;
      document.getElementById("safetyDate").textContent = `Updated as of ${date}`;
      document.getElementById("healthDate").textContent = `Updated as of ${date}`;
    }

    document.addEventListener("DOMContentLoaded", () => {
      const reportLink = document.querySelector('a[href="report.html"]');
      if (currentUser?.role !== "resident" && reportLink) {
        reportLink.classList.add("disabled-link");
        reportLink.title = "Only residents can file reports.";
      }
      renderAnnouncements();
      fillContacts();
      renderThread();
      loadCharts();
    });
  </script>
</body>
</html>
