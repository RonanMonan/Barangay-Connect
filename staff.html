<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Staff Role Management | BarangayConnect</title>
    <link rel="stylesheet" href="style.css" />
    <style>
        /* --- Custom Header Styling for White Links (no underline on hover) --- */
        .navbar a {
            color: white !important; /* Force links to be white */
            text-decoration: none; /* Ensure no unwanted underlines by default */
        }
        .navbar a:hover, .navbar a.active {
            text-decoration: none; /* Explicitly remove underline on hover and for active link */
        }
        /* ----------------------------------------------------------------- */
        
        /* Styles adapted from report.html and enhanced for table display */
        .container h2 { padding-top: 5%; }
        .staff-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .staff-table th, .staff-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
            vertical-align: middle;
        }
        .staff-table th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        .staff-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .role-selector {
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ccc;
            width: 100%;
            box-sizing: border-box;
        }
        .save-btn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 8px 15px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        .save-btn:hover {
            background-color: #0056b3;
        }
        .role-description-list {
            list-style: disc;
            margin-left: 20px;
            padding-left: 0;
        }
        .role-description-list li {
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <header class="navbar">
        <img src="logo.png" alt="Barangay Logo" class="logo">
        <h1>BarangayConnect - Admin</h1>
        <nav>
            <b>|</b>
            <a href="resident.html">Official Dashboard</a>
            <b>|</b>
            <a href="resident.html">Resident Reports</a>
            <b>|</b>
            <button id="logoutBtn" class="logout">Logout</button>
        </nav>
    </header>

    <main class="container">
        <h2>Staff and Role Assignment</h2>
        
        <p>This page allows the Barangay Captain to assign operational roles to all staff and volunteers.</p>

        <table class="staff-table">
            <thead>
                <tr>
                    <th>Staff Name (ID)</th>
                    <th>Current Role</th>
                    <th>Assign New Role</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="staffListBody">
                <tr><td colspan='4'>Loading staff...</td></tr>
            </tbody>
        </table>

        ---

        <section style="margin-top: 40px;">
            <h3>Role Descriptions</h3>
            <ul class="role-description-list">
                <li>Officials: Primary handler for incoming reports (categorizing, updating status).</li>
                <li>Help Desk: Provides aid with Ticket Chat for the Officials.</li>
                <li>Volunteer: Basic system access for general tasks or data quality checks.</li>
                <li>Resident: Standard user (should not appear here if properly filtered).</li>
            </ul>
        </section>
    </main>

    <footer class="foot"><small>BarangayConnect â€” Staff Role Management</small></footer>

    <script>
        // --- Configuration ---
        const staffListBody = document.getElementById('staffListBody');
        // List of roles that staff/volunteers can be assigned
        const assignableRoles = ["help desk", "official", "volunteer", "inactive", "resident"];
        
        // === Auth Check (Crucial for Admin Pages) ===
        const currentUser = JSON.parse(localStorage.getItem("currentUser"));
        if (!currentUser || currentUser.role !== "captain") { 
            alert("Access denied. Only the Barangay Captain can manage roles.");
            window.location.href = "index.html"; 
        }

        // === Logout Function ===
        document.getElementById("logoutBtn").addEventListener("click", () => {
            localStorage.removeItem("currentUser");
            window.location.href = "index.html";
        });

        // === Load Staff List Function ===
        function loadStaff() {
            staffListBody.innerHTML = "<tr><td colspan='4'>Loading staff list...</td></tr>";
            
            try {
                // Retrieve all users from localStorage
                const allUsers = JSON.parse(localStorage.getItem("users")) || [];
                staffListBody.innerHTML = ""; // Clear loading message

                // Filter for users who are NOT the captain or LGU
                const manageableStaff = allUsers.filter(u => u.role !== 'captain' && u.role !== 'lgu');

                if (manageableStaff.length === 0) {
                    staffListBody.innerHTML = `<tr><td colspan='4'>No staff or volunteers found.</td></tr>`;
                    return;
                }

                manageableStaff.forEach((staff) => {
                    // Use email as the unique identifier
                    const userId = staff.email; 
                    const row = createStaffRow(userId, staff.name, staff.role);
                    staffListBody.appendChild(row);
                });
                
                // Attach event listeners to all new 'Save' buttons
                document.querySelectorAll('.save-btn').forEach(button => {
                    button.addEventListener('click', handleRoleSave);
                });

            } catch (error) {
                console.error("Error loading staff:", error);
                staffListBody.innerHTML = `<tr><td colspan='4' style='color: red;'>Error loading staff: ${error.message}</td></tr>`;
            }
        }

        // === Helper: Create Staff Row HTML Element ===
        function createStaffRow(userId, name, currentRole) {
            const tr = document.createElement('tr');
            
            // Build the options for the <select> dropdown
            const roleOptions = assignableRoles.map(role => 
                `<option value="${role}" ${role === currentRole ? 'selected' : ''}>${role}</option>`
            ).join('');

            tr.innerHTML = `
                <td>${name} (<small>${userId}</small>)</td>
                <td><span id="current-role-${userId}">${currentRole}</span></td>
                <td>
                    <select class="role-selector" id="new-role-${userId}">
                        ${roleOptions}
                    </select>
                </td>
                <td>
                    <button class="save-btn" data-user-id="${userId}">Save</button>
                </td>
            `;
            return tr;
        }

        // === Handle Role Save Function ===
        function handleRoleSave(event) {
            const userId = event.target.getAttribute('data-user-id');
            const selector = document.getElementById(`new-role-${userId}`);
            const newRole = selector.value;
            const currentRoleSpan = document.getElementById(`current-role-${userId}`);

            if (!userId || !newRole) return;

            const button = event.target;
            button.textContent = 'Saving...';
            button.disabled = true;

            try {
                let usersArray = JSON.parse(localStorage.getItem("users")) || [];
                const userIndex = usersArray.findIndex(u => u.email === userId);

                if (userIndex !== -1) {
                    // Update the role in the local array
                    usersArray[userIndex].role = newRole;

                    // IMPORTANT: You also need to check if the user being updated is the CURRENTLY logged-in user (the captain).
                    // If the Captain somehow changes their own role, their permissions must update immediately.
                    if (currentUser.email === userId) {
                         // Update the role in the Captain's currentUser object
                        currentUser.role = newRole; 
                        localStorage.setItem("currentUser", JSON.stringify(currentUser));
                    }

                } else {
                    throw new Error("User not found in storage.");
                }

                // Save the modified array back to localStorage
                localStorage.setItem("users", JSON.stringify(usersArray));

                // Update the display on the page
                currentRoleSpan.textContent = newRole;
                button.textContent = 'Saved!';

                setTimeout(() => {
                    button.textContent = 'Save';
                    button.disabled = false;
                }, 2000);

            } catch (error) {
                console.error("Error updating role:", error);
                alert("Failed to update role. Check console for details.");
                button.textContent = 'Error';
                button.disabled = false;
            }
        }

        // Initialize on page load
        document.addEventListener("DOMContentLoaded", loadStaff);
    </script>
</body>

</html>



